# Blixard

**Blixard** is a CLI tool for generating and managing NixOS infrastructure, including configurations for MicroVMs, SSH keys, and encrypted configuration files using `sops`. This tool simplifies the process of setting up and managing NixOS environments and supports integration with GitHub Actions for continuous deployment.

## Features

- Generate SSH keys for projects
- Generate Nix modules for MicroVMs
- Generate `flake.nix` configurations
- Generate host configurations for MicroVMs
- Generate and encrypt configuration files using `sops` for various services (Tailscale, AWS, Cloudflare, Wiki.js)
- Generate GitHub Actions workflows for automated CI/CD
- Generate Nginx configurations and add them to your service list

## Installation
# Usage as a flake

[![FlakeHub](https://img.shields.io/endpoint?url=https://flakehub.com/f/BrittonR/blixard/badge)](https://flakehub.com/flake/BrittonR/blixard)

Add blixard to your `flake.nix`:

```nix
{
  inputs.blixard.url = "https://flakehub.com/f/BrittonR/blixard/*.tar.gz";

  outputs = { self, blixard }: {
    # Use in your outputs
  };
}

```

# Build from Source
Clone the repository and build the CLI tool using Cargo:

```sh
git clone https://github.com/brittonr/blixard.git
cd blixard
cargo build --release
```

After building, you can find the executable in the `target/release` directory.

## Usage

### Command Line Interface

The CLI provides several commands for different tasks:

```sh
blixard ssh-keys [OPTIONS]
blixard microvm [OPTIONS]
blixard flake
blixard host
blixard sops <SUBCOMMAND>
blixard action --name <NAME> --working-directory <WORKING_DIRECTORY>
blixard nginx --name <NAME> --port <PORT> --ip <IP> --enabled <ENABLED>
```

For detailed options and subcommands, use `blixard --help` or `blixard <COMMAND> --help`.

## Flake Generation Process

When you run `blixard flake`, the tool generates a `flake.nix` file for your NixOS configuration:

1. Blixard generates the content for the `flake.nix` file, including:
   - A description of your NixOS configuration
   - Input declarations for various dependencies
   - Output configurations for your NixOS systems

2. The tool creates (or overwrites) the `flake.nix` file in your current directory.

3. Blixard runs `nixfmt` to ensure your `flake.nix` file is properly formatted.

### What's in the Generated Flake?

The `flake.nix` file contains:

#### Inputs

Declarations for dependencies such as:
- `nixpkgs`
- `home-manager`
- `flake-utils`
- `nix-darwin`
- `sops-nix`
- `microvm`
- `disko`
- `terranix`
- `nixos-hardware`
- `deploy-rs`

#### Outputs

1. **NixOS Configurations**:
   ```nix
   nixosConfigurations = {
     inherit (nixConfiguration);
   };
   ```
   This imports NixOS configurations from `./nixos/nixos-configurations.nix`.

2. **Deployment Configuration**:
   ```nix
   deploy = deploy;
   ```
   This imports deployment configurations from `./nixos/deploy-config.nix`.

## Using deploy.nix with deploy-rs

The `deploy.nix` file generated by Blixard is designed to work seamlessly with `deploy-rs`, a tool for deploying NixOS systems. 

### Structure of deploy.nix

Blixard generates a `deploy.nix` file that includes a `mkNode` function and a set of nodes that can be deployed. The structure typically looks like this:

```nix
{ inputs, ... }:
let
  inherit (inputs) self nixpkgs deploy-rs;

  mkNode = server: ip: fast: {
    hostname = "${ip}";
    fastConnection = fast;
    sshOpts = [ "-i" "/home/admin/.ssh/admin" ];
    profiles.system.path = deploy-rs.lib.x86_64-linux.activate.nixos self.nixosConfigurations."${server}";
  };

in {
  user = "admin";
  sshUser = "admin";
  nodes = {
    example-node = mkNode "example-node" "192.168.1.100" true;
    # Other nodes...
  };
}
```

### The mkNode Function

The `mkNode` function is a key part of Blixard's deployment configuration. It takes three arguments:

1. `server`: The name of the server (corresponds to a NixOS configuration)
2. `ip`: The IP address or hostname of the target machine
3. `fast`: A boolean indicating whether the connection is fast (affects deployment behavior)

This function returns a node configuration object that `deploy-rs` can use.

### Adding New Nodes

When you use Blixard to generate a new MicroVM or system configuration, it automatically adds a new node to the `nodes` attribute using the `mkNode` function. For example:

```nix
nodes = {
  existing-node = ...
  new-microvm = mkNode "new-microvm" "192.168.1.101" true;
};
```

### Deploying a System

To deploy a system defined in your `deploy.nix`:

1. Ensure `deploy-rs` is in the current shell:
   ```sh
   nix-shell nixpkgs.deploy-rs
   ```

2. Run the deploy command:
   ```sh
   deploy .#new-microvm
   ```
   Replace `new-microvm` with the name of the node you want to deploy.

3. `deploy-rs` will:
   - Build the NixOS configuration for the specified node
   - SSH into the target machine using the provided SSH options
   - Copy the built system closure
   - Activate the new system configuration

### Deploying Multiple Systems

You can deploy multiple systems in one command:

```sh
deploy .#node1 .#node2 .#node3
```

### Checking Deployments

To check if your systems are up-to-date without actually deploying:

```sh
deploy --check .#new-microvm
```

### Rollbacks

If a deployment fails, `deploy-rs` will automatically roll back to the previous configuration. You can also manually roll back:

```sh
deploy --rollback .#new-microvm
```
